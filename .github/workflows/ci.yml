name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Node.js setup
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Node.js dependencies
        run: npm ci

      - name: Lint TypeScript/JavaScript
        run: npm run lint

      - name: Check formatting
        run: npm run format:check

      - name: Type check
        run: npm run typecheck

      - name: Build MCP server
        run: npm run build

      # Python setup
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy black pylint

      - name: Lint Python with Ruff
        run: |
          cd python
          ruff check .

      - name: Check Python formatting with Black
        run: |
          cd python
          black --check .

      - name: Type check Python with MyPy
        run: |
          cd python
          # TODO: Remove || true once type coverage is complete
          mypy --install-types --non-interactive . || echo "⚠️ Type checking found issues but continuing for now"

  test-install:
    runs-on: ubuntu-latest
    needs: lint-and-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Test TypeScript package installation
        run: |
          cd typescript
          npm pack
          mkdir -p /tmp/test-ts-install
          cp *.tgz /tmp/test-ts-install/
          cd /tmp/test-ts-install
          npm init -y
          npm install ./$(ls *.tgz)
          echo "✅ TypeScript package installs successfully"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Test Python package build
        run: |
          python -m pip install --upgrade pip build
          cd python
          python -m build
          pip install dist/*.whl
          python -c "from lint_configs import __version__; print(f'✅ Python package v{__version__} installs successfully')"

  test-mcp-server:
    runs-on: ubuntu-latest
    needs: lint-and-build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install and build MCP server
        run: |
          npm ci
          cd mcp-server
          npm run build

      - name: Test MCP server starts
        run: |
          cd mcp-server
          timeout 5s node dist/server.js || [ $? -eq 124 ] && echo "✅ MCP server starts successfully"
